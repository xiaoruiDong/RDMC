import pytest

import numpy as np
from rdkit.Chem import rdChemReactions

from rdtools.conf import add_conformer
from rdtools.conversion import mol_from_smiles, mol_to_smiles
from rdtools.compare import is_same_connectivity_mol
from rdtools.reaction.draw import draw_reaction
from rdtools.reaction.stereo import is_DA_rxn_endo
from rdtools.reaction.ts import (
    guess_rxn_from_normal_mode,
    examine_normal_mode,
    is_valid_habs_ts,
)


@pytest.mark.parametrize(
    "smi",
    [
        "[CH3:1][CH3:2]>>[CH2:1]=[CH2:2].[H:3][H:4]",
        "[C:1]([C:2]([H:4])([H:7])[H:8])([H:3])([H:5])[H:6]>>"
        "[C:1](=[C:2]([H:7])[H:8])([H:5])[H:6].[H:3][H:4]",
    ]
)
@pytest.mark.parametrize(
    "figsize", [(800, 300), (400, 400)]
)
@pytest.mark.parametrize(
    "font_scale", [0.5, 1.0, 2.0]
)
@pytest.mark.parametrize(
    "highlight_atoms", [True, False]
)
def test_draw_reaction(smi, figsize, font_scale, highlight_atoms):
    """
    Test issue-free in the workflow drawing a reaction
    """
    rxn = rdChemReactions.ReactionFromSmarts(
        smi,
        useSmiles=True,
    )
    draw_reaction(rxn, figsize, font_scale, highlight_atoms)


@pytest.mark.parametrize(
    "rsmi, psmi, xyz, is_endo",
    [
        (
            '[C:1]1([H:11])=[C:2]([H:20])[C:3]([H:18])([H:19])[C:4]([H:17])=[C:5]1[H:16]'
            '.[C:6]1([H:14])=[C:10]([H:15])[C:9]([H:21])([H:22])[C:8]([H:12])=[C:7]1[H:13]',
            '[C:1]1([H:11])=[C:2]([H:20])[C:3]([H:18])([H:19])[C:4]2([H:17])[C:5]1([H:16])'
            '[C:10]1([H:15])[C:6]([H:14])=[C:7]([H:13])[C:8]2([H:12])[C:9]1([H:21])[H:22]',
            np.array(
                [[ 1.58239292,  0.947867  ,  0.87011527],
                [ 2.32720041,  0.47186454, -0.11298323],
                [ 1.62508288, -0.65470284, -0.80223801],
                [ 0.41826859, -0.97342439,  0.00722794],
                [ 0.31604545,  0.20793456,  0.95216726],
                [-2.08573637,  0.23070767,  0.90785504],
                [-1.99538695, -0.92569041,  0.23619053],
                [-0.88051625, -0.85977855, -0.74686039],
                [-0.87772573,  0.65916647, -1.00250775],
                [-0.88298583,  1.0043838 ,  0.49522599],
                [ 1.8727404 ,  1.77410049,  1.52545979],
                [-0.98415808, -1.45098692, -1.62581691],
                [-2.63182746, -1.78593942,  0.37821339],
                [-2.86095707,  0.55081113,  1.60571287],
                [-0.8833314 ,  2.04222842,  0.71265003],
                [ 0.17183746, -0.1453118 ,  2.01181012],
                [ 0.47983332, -1.93604015,  0.53157701],
                [ 2.33567944, -1.53024826, -0.7173578 ],
                [ 1.41789586, -0.44559368, -1.86196459],
                [ 3.30628381,  0.85878014, -0.3662394 ],
                [-1.79557123,  0.96315794, -1.49906233],
                [ 0.02493581,  0.99671425, -1.49917481]]
            ),
            False,
        ),
        (
            '[C:1]1([H:11])=[C:2]([H:20])[C:3]([H:18])([H:19])[C:4]2([H:17])[C:5]1([H:16])'
            '[C:10]1([H:15])[C:6]([H:14])=[C:7]([H:13])[C:8]2([H:12])[C:9]1([H:21])[H:22]',
            '[C:1]1([H:11])=[C:2]([H:20])[C:3]([H:18])([H:19])[C:4]([H:17])=[C:5]1[H:16]'
            '.[C:6]1([H:14])=[C:10]([H:15])[C:9]([H:21])([H:22])[C:8]([H:12])=[C:7]1[H:13]',
            np.array(
                [[ 1.58239292,  0.947867  ,  0.87011527],
                [ 2.32720041,  0.47186454, -0.11298323],
                [ 1.62508288, -0.65470284, -0.80223801],
                [ 0.41826859, -0.97342439,  0.00722794],
                [ 0.31604545,  0.20793456,  0.95216726],
                [-2.08573637,  0.23070767,  0.90785504],
                [-1.99538695, -0.92569041,  0.23619053],
                [-0.88051625, -0.85977855, -0.74686039],
                [-0.87772573,  0.65916647, -1.00250775],
                [-0.88298583,  1.0043838 ,  0.49522599],
                [ 1.8727404 ,  1.77410049,  1.52545979],
                [-0.98415808, -1.45098692, -1.62581691],
                [-2.63182746, -1.78593942,  0.37821339],
                [-2.86095707,  0.55081113,  1.60571287],
                [-0.8833314 ,  2.04222842,  0.71265003],
                [ 0.17183746, -0.1453118 ,  2.01181012],
                [ 0.47983332, -1.93604015,  0.53157701],
                [ 2.33567944, -1.53024826, -0.7173578 ],
                [ 1.41789586, -0.44559368, -1.86196459],
                [ 3.30628381,  0.85878014, -0.3662394 ],
                [-1.79557123,  0.96315794, -1.49906233],
                [ 0.02493581,  0.99671425, -1.49917481]]
            ),
            False,
        ),
        (
            '[C:1]1([H:11])=[C:2]([H:20])[C:3]([H:18])([H:19])[C:4]([H:17])=[C:5]1[H:16]'
            '.[C:6]1([H:14])=[C:10]([H:15])[C:9]([H:21])([H:22])[C:8]([H:12])=[C:7]1[H:13]',
            '[C:1]1([H:11])=[C:2]([H:20])[C:3]([H:18])([H:19])[C:4]2([H:17])[C:5]1([H:16])'
            '[C:10]1([H:15])[C:6]([H:14])=[C:7]([H:13])[C:8]2([H:12])[C:9]1([H:21])[H:22]',
            np.array(
                [[ 1.13381571,  1.30804996, -0.17827677],
                [ 1.93642874,  0.61022954,  0.61715822],
                [ 1.76593412, -0.825791  ,  0.38732069],
                [ 0.52091035, -0.96773407, -0.38432868],
                [ 0.32963782,  0.40412658, -1.03668264],
                [-1.25859611,  1.18129307,  0.598585  ],
                [-0.92830933,  0.09603857,  1.32746642],
                [-0.73714783, -1.08295044,  0.41145555],
                [-1.73051338, -0.65932017, -0.69240543],
                [-1.12275483,  0.75228611, -0.81359293],
                [ 1.12135041,  2.38966919, -0.14961674],
                [-0.96295141, -2.02970422,  0.84769361],
                [-0.83571677,  0.14826557,  2.39754338],
                [-1.55713166,  2.15185506,  0.95521916],
                [-1.58555748,  1.36307755, -1.54958993],
                [ 0.62437355,  0.40236537, -2.08418116],
                [ 0.51847919, -1.7721312 , -1.14224225],
                [ 2.62337775, -1.16189955, -0.26031514],
                [ 1.82627808, -1.43688551,  1.30597398],
                [ 2.64594702,  1.0073441 ,  1.35928412],
                [-1.57410198, -1.24748921, -1.59810209],
                [-2.75375195, -0.63069527, -0.31836636]]
            ),
            True,
        ),
    ]
)
def test_is_DA_rxn_endo(rsmi, psmi, xyz, is_endo):

    rmol = mol_from_smiles(rsmi)
    pmol = mol_from_smiles(psmi)

    if '.' in rsmi:  # diene and dienophile side
        add_conformer(pmol, coords=xyz)
    else:
        add_conformer(rmol, coords=xyz)

    assert is_endo == is_DA_rxn_endo(rmol, pmol)


@pytest.mark.parametrize(
    "xyz, symbols, disp, amplitude, rsmi, psmi",
    [
        (
            np.array(
                [[ 1.863565,  0.006596, -0.263742],
                [ 2.708847, -0.369725,  0.49238 ],
                [ 0.606777,  0.738588,  0.139055],
                [ 1.953033, -0.151205, -1.356383],
                [-0.60282 ,  0.183493, -0.611901],
                [ 0.466607,  0.641164,  1.216166],
                [ 0.750003,  1.790903, -0.117357],
                [-1.200529, -0.866061, -0.171513],
                [-0.564811,  0.314551, -1.703776],
                [-1.626625,  0.908707, -0.245062],
                [-2.599114,  0.102671,  0.401083],
                [-3.456968, -0.01126 ,  0.850342]]
            ),
            ['C', 'O', 'C', 'H', 'C', 'H', 'H', 'O', 'H', 'H', 'O', 'H'],
            np.array(
                [[ 0.  ,  0.  ,  0.  ],
                [ 0.  , -0.  ,  0.  ],
                [ 0.01, -0.01, -0.  ],
                [-0.  , -0.  ,  0.  ],
                [-0.02,  0.07, -0.01],
                [-0.  ,  0.  , -0.  ],
                [ 0.  , -0.01,  0.  ],
                [-0.07,  0.  ,  0.03],
                [ 0.11, -0.13, -0.03],
                [ 0.78,  0.14, -0.44],
                [ 0.01, -0.03, -0.  ],
                [ 0.08, -0.35,  0.02]],
            ),
            0.25,
            '[C:1](=[O:2])([C:3]([C:5](=[O:8])[H:9])([H:6])[H:7])[H:4].[H:10][O:11][H:12]',
            '[C:1](=[O:2])([C:3]([C:5]([O:8][O:11][H:12])([H:9])[H:10])([H:6])[H:7])[H:4]',
        ),
        (
            np.array(
                [[-1.562687, -1.027037, -0.222904],
                [-0.620652,  0.111238, -0.095917],
                [-1.328443,  1.446314, -0.014302],
                [ 0.721894, -0.041027, -0.015527],
                [ 1.699748,  1.105148,  0.084138],
                [-2.034387, -1.29701 ,  0.876878],
                [-1.145364, -1.970026, -0.566962],
                [-2.458753, -0.779693, -0.796004],
                [-1.849101,  1.669699, -0.952776],
                [-2.096199,  1.41006 ,  0.767274],
                [-0.671222,  2.282863,  0.213267],
                [ 1.254297,  2.084589, -0.077121],
                [ 2.500491,  0.980219, -0.653888],
                [ 2.186843,  1.113691,  1.067429],
                [-2.507134, -1.581814,  1.831978],
                [ 1.415097, -1.382949, -0.015157],
                [ 0.738778, -2.232895,  0.046637],
                [ 2.030398, -1.502138, -0.915673],
                [ 2.10161 , -1.447666,  0.836981]],
            ),
            ['C', 'C', 'C', 'C', 'C', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'H', 'C', 'H', 'H', 'H'],
            np.array(
                [[ 0.04,  0.04, -0.05],
                [-0.03, -0.02,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.01, -0.01,  0.01],
                [ 0.  ,  0.  ,  0.  ],
                [-0.3 , -0.18,  0.66],
                [-0.03, -0.06,  0.14],
                [-0.1 , -0.02,  0.18],
                [ 0.  ,  0.01,  0.  ],
                [ 0.  ,  0.01,  0.  ],
                [ 0.01, -0.01,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.26,  0.16, -0.52],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ]]
            ),
            0.3,
            '[C:1]([C:2]([C:3]([H:9])([H:10])[H:11])=[C:4]([C:5]([H:12])([H:13])[H:14])'
            '[C:16]([H:17])([H:18])[H:19])([H:6])([H:7])[H:8].[H:15]',
            '[C:1]([C:2]([C:3]([H:9])([H:10])[H:11])=[C:4]([C:5]([H:12])([H:13])[H:14])'
            '[C:16]([H:17])([H:18])[H:19])([H:7])[H:8].[H:6][H:15]',

        )
    ],
)
def test_guess_rxn_from_normal_mode(xyz, symbols, disp, amplitude, rsmi, psmi):

    rguess, pguess = guess_rxn_from_normal_mode(xyz, symbols, disp, amplitude)

    assert mol_to_smiles(rguess[0], remove_hs=False, remove_atom_map=False) == rsmi
    assert mol_to_smiles(pguess[0], remove_hs=False, remove_atom_map=False) == psmi


@pytest.mark.parametrize(
    "xyz, disp, rsmi, psmi",
    [
        (
            np.array(
                [[ 1.863565,  0.006596, -0.263742],
                [ 2.708847, -0.369725,  0.49238 ],
                [ 0.606777,  0.738588,  0.139055],
                [ 1.953033, -0.151205, -1.356383],
                [-0.60282 ,  0.183493, -0.611901],
                [ 0.466607,  0.641164,  1.216166],
                [ 0.750003,  1.790903, -0.117357],
                [-1.200529, -0.866061, -0.171513],
                [-0.564811,  0.314551, -1.703776],
                [-1.626625,  0.908707, -0.245062],
                [-2.599114,  0.102671,  0.401083],
                [-3.456968, -0.01126 ,  0.850342]]
            ),
            np.array(
                [[ 0.  ,  0.  ,  0.  ],
                [ 0.  , -0.  ,  0.  ],
                [ 0.01, -0.01, -0.  ],
                [-0.  , -0.  ,  0.  ],
                [-0.02,  0.07, -0.01],
                [-0.  ,  0.  , -0.  ],
                [ 0.  , -0.01,  0.  ],
                [-0.07,  0.  ,  0.03],
                [ 0.11, -0.13, -0.03],
                [ 0.78,  0.14, -0.44],
                [ 0.01, -0.03, -0.  ],
                [ 0.08, -0.35,  0.02]],
            ),
            '[C:1](=[O:2])([C:3]([C:5](=[O:8])[H:9])([H:6])[H:7])[H:4].[H:10][O:11][H:12]',
            '[C:1](=[O:2])([C:3]([C:5]([O:8][O:11][H:12])([H:9])[H:10])([H:6])[H:7])[H:4]',
        ),
        (
            np.array(
                [[-1.562687, -1.027037, -0.222904],
                [-0.620652,  0.111238, -0.095917],
                [-1.328443,  1.446314, -0.014302],
                [ 0.721894, -0.041027, -0.015527],
                [ 1.699748,  1.105148,  0.084138],
                [-2.034387, -1.29701 ,  0.876878],
                [-1.145364, -1.970026, -0.566962],
                [-2.458753, -0.779693, -0.796004],
                [-1.849101,  1.669699, -0.952776],
                [-2.096199,  1.41006 ,  0.767274],
                [-0.671222,  2.282863,  0.213267],
                [ 1.254297,  2.084589, -0.077121],
                [ 2.500491,  0.980219, -0.653888],
                [ 2.186843,  1.113691,  1.067429],
                [-2.507134, -1.581814,  1.831978],
                [ 1.415097, -1.382949, -0.015157],
                [ 0.738778, -2.232895,  0.046637],
                [ 2.030398, -1.502138, -0.915673],
                [ 2.10161 , -1.447666,  0.836981]],
            ),
            np.array(
                [[ 0.04,  0.04, -0.05],
                [-0.03, -0.02,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.01, -0.01,  0.01],
                [ 0.  ,  0.  ,  0.  ],
                [-0.3 , -0.18,  0.66],
                [-0.03, -0.06,  0.14],
                [-0.1 , -0.02,  0.18],
                [ 0.  ,  0.01,  0.  ],
                [ 0.  ,  0.01,  0.  ],
                [ 0.01, -0.01,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.26,  0.16, -0.52],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ]]
            ),
            '[C:1]([C:2]([C:3]([H:9])([H:10])[H:11])=[C:4]([C:5]([H:12])([H:13])[H:14])'
            '[C:16]([H:17])([H:18])[H:19])([H:6])([H:7])[H:8].[H:15]',
            '[C:1]([C:2]([C:3]([H:9])([H:10])[H:11])=[C:4]([C:5]([H:12])([H:13])[H:14])'
            '[C:16]([H:17])([H:18])[H:19])([H:7])[H:8].[H:6][H:15]',

        )
    ],
)
def test_examine_normal_mode(xyz, disp, rsmi, psmi):

    rmol = mol_from_smiles(rsmi)
    pmol = mol_from_smiles(psmi)

    assert examine_normal_mode(
        rmol, pmol, xyz, disp, verbose=False, as_factors=False
    )


@pytest.mark.parametrize(
    "xyz, disp, rsmi, psmi",
    [
        (
            np.array(
                [[-1.562687, -1.027037, -0.222904],
                [-0.620652,  0.111238, -0.095917],
                [-1.328443,  1.446314, -0.014302],
                [ 0.721894, -0.041027, -0.015527],
                [ 1.699748,  1.105148,  0.084138],
                [-2.034387, -1.29701 ,  0.876878],
                [-1.145364, -1.970026, -0.566962],
                [-2.458753, -0.779693, -0.796004],
                [-1.849101,  1.669699, -0.952776],
                [-2.096199,  1.41006 ,  0.767274],
                [-0.671222,  2.282863,  0.213267],
                [ 1.254297,  2.084589, -0.077121],
                [ 2.500491,  0.980219, -0.653888],
                [ 2.186843,  1.113691,  1.067429],
                [-2.507134, -1.581814,  1.831978],
                [ 1.415097, -1.382949, -0.015157],
                [ 0.738778, -2.232895,  0.046637],
                [ 2.030398, -1.502138, -0.915673],
                [ 2.10161 , -1.447666,  0.836981]],
            ),
            np.array(
                [[ 0.04,  0.04, -0.05],
                [-0.03, -0.02,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.01, -0.01,  0.01],
                [ 0.  ,  0.  ,  0.  ],
                [-0.3 , -0.18,  0.66],
                [-0.03, -0.06,  0.14],
                [-0.1 , -0.02,  0.18],
                [ 0.  ,  0.01,  0.  ],
                [ 0.  ,  0.01,  0.  ],
                [ 0.01, -0.01,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.26,  0.16, -0.52],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ],
                [ 0.  ,  0.  ,  0.  ]]
            ),
            '[C:1]([C:2]([C:3]([H:9])([H:10])[H:11])=[C:4]([C:5]([H:12])([H:13])[H:14])'
            '[C:16]([H:17])([H:18])[H:19])([H:6])([H:7])[H:8].[H:15]',
            '[C:1]([C:2]([C:3]([H:9])([H:10])[H:11])=[C:4]([C:5]([H:12])([H:13])[H:14])'
            '[C:16]([H:17])([H:18])[H:19])([H:7])[H:8].[H:6][H:15]',

        )
    ],
)
def test_is_valid_habs_ts(xyz, disp, rsmi, psmi):

    rmol = mol_from_smiles(rsmi)
    pmol = mol_from_smiles(psmi)

    assert is_valid_habs_ts(
        rmol, pmol, xyz, disp
    )
